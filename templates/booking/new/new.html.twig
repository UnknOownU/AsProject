{% extends 'base.html.twig' %}

{% block title %}Sélectionnez un créneau horaire{% endblock %}

{% block body %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Créer un rendez-vous</h1>

    {{ form_start(form, {'attr': {'id': 'appointmentForm'}}) }}

    <!-- Affichage des erreurs de formulaire globales -->
    {% if form_errors(form) %}
        <div class="alert alert-danger">
            {{ form_errors(form) }}
        </div>
    {% endif %}

    <!-- Étape 1: Choisir le type de véhicule -->
    <div id="step1" class="step">
        <h2 class="text-center mb-4">Étape 1: Choisir le type de véhicule</h2>
        <div class="row justify-content-center">
            <div class="col-md-3 mb-3">
                {{ form_label(form.inspectionForm.carType) }}
                {{ form_widget(form.inspectionForm.carType, {'attr': {'class': 'form-select', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.carType) }}
            </div>
            <div class="col-md-3 mb-3">
                {{ form_label(form.inspectionForm.fuelType) }}
                {{ form_widget(form.inspectionForm.fuelType, {'attr': {'class': 'form-select', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.fuelType) }}
            </div>
            <div class="col-md-3 mb-3">
                {{ form_label(form.inspectionForm.controlType) }}
                {{ form_widget(form.inspectionForm.controlType, {'attr': {'class': 'form-select', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.controlType) }}
            </div>
        </div>
        <div class="text-center mt-4">
            <button type="button" class="btn btn-warning btn-lg" id="step1NextButton">Suivant</button>
        </div>
    </div>

    <!-- Étape 2: Informations personnelles -->
    <div id="step2" class="step" style="display: none;">
        <h2 class="text-center mb-4">Étape 2: Informations personnelles</h2>
        <div class="row">
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.firstname) }}
                {{ form_widget(form.inspectionForm.firstname, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.firstname) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.lastname) }}
                {{ form_widget(form.inspectionForm.lastname, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.lastname) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.email) }}
                {{ form_widget(form.inspectionForm.email, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.email) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.phone) }}
                {{ form_widget(form.inspectionForm.phone, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.phone) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.carBrand) }}
                {{ form_widget(form.inspectionForm.carBrand, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.carBrand) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.carModel) }}
                {{ form_widget(form.inspectionForm.carModel, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.carModel) }}
            </div>
            <div class="col-md-6 mb-3">
                {{ form_label(form.inspectionForm.licensePlate) }}
                {{ form_widget(form.inspectionForm.licensePlate, {'attr': {'class': 'form-control', 'required': 'required'}}) }}
                {{ form_errors(form.inspectionForm.licensePlate) }}
            </div>
        </div>
        <div class="text-center mt-4">
            <button type="button" class="btn btn-secondary btn-lg" onclick="previousStep(1)">Précédent</button>
            <button type="button" class="btn btn-warning btn-lg" id="step2NextButton">Suivant</button>
        </div>
    </div>

    <!-- Étape 3: Sélectionner un créneau horaire -->
    <div id="step3" class="step" style="display: none;">
        <h2 class="text-center mb-4">Étape 3: Sélectionner un créneau horaire</h2>
        <div class="table-responsive">
            <table class="table table-bordered table-dark table-hover text-warning">
                <thead>
                    <tr>
                        <th scope="col">Heures</th>
                        {% for day in days %}
                            <th class="text-center">{{ day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for hour in hours %}
                        <tr>
                            <td class="fw-bold">{{ hour }}</td>
                            {% for day in days %}
                                {% set slot = timeslotsByDay[day|slice(0,3)][hour] %}
                                <td class="text-center 
                                    {% if slot and not slot.isAvailable %}
                                        bg-secondary text-light
                                    {% elseif not slot %}
                                        bg-dark text-white
                                    {% else %}
                                        bg-dark text-warning
                                    {% endif %}">
                                    {% if slot %}
                                        {% if slot.isAvailable %}
                                           <div class="form-check text-center">
                                               <input type="radio" name="timeslot" id="timeslot_{{ slot.id }}" value="{{ slot.id }}" class="form-check-input">
                                               <label for="timeslot_{{ slot.id }}" class="form-check-label">
                                                   {{ slot.getStartTime().format('H:i') ~ ' - ' ~ slot.getEndTime().format('H:i') }}
                                               </label>
                                           </div>
                                        {% else %}
                                            <span class="text-danger"><del>{{ slot.getStartTime().format('H:i') }} - {{ slot.getEndTime().format('H:i') }} (Réservé)</del></span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-white">Indisponible</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-center mt-4">
            <button type="button" class="btn btn-secondary btn-lg" onclick="previousStep(2)">Précédent</button>
            <button type="submit" class="btn btn-warning btn-lg">Réserver ce créneau</button>
        </div>
    </div>

    {{ form_end(form, {'render_rest': true}) }}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let currentStep = 1;

    function showStep(step) {
        document.querySelectorAll('.step').forEach(function (el) {
            el.style.display = 'none';
        });
        const stepElement = document.getElementById('step' + step);
        if (stepElement) {
            stepElement.style.display = 'block';
        }
    }

    function validateStep1() {
        const step1Fields = document.querySelectorAll('#step1 .form-select');
        let valid = true;

        step1Fields.forEach(function (field) {
            if (!field.value) {
                valid = false;
            }
        });

        return valid;
    }

    function validateStep2() {
        const step2Fields = document.querySelectorAll('#step2 .form-control');
        let valid = true;

        step2Fields.forEach(function (field) {
            if (!field.value.trim()) {
                valid = false;
            }
        });

        return valid;
    }

    document.getElementById('step1NextButton').addEventListener('click', function () {
        if (validateStep1()) {
            nextStep(2);
        } else {
            alert('Veuillez remplir tous les champs avant de passer à l\'étape suivante.');
        }
    });

    document.getElementById('step2NextButton').addEventListener('click', function () {
        if (validateStep2()) {
            nextStep(3);
        } else {
            alert('Veuillez remplir tous les champs avant de passer à l\'étape suivante.');
        }
    });

    window.nextStep = function (step) {
        currentStep = step;
        showStep(step);
    };

    window.previousStep = function (step) {
        currentStep = step;
        showStep(step);
    };

    // Show the first step initially
    showStep(1);
});
</script>

<style>
.timeslot-btn.selected {
    background-color: #28a745;
    color: white;
}
.table-timeslots {
    width: 100%;
    margin-top: 20px;
}

.table-timeslots th {
    text-align: center;
    background-color: #343a40;
    color: white;
    padding: 10px;
}

.table-timeslots td {
    text-align: center;
    padding: 10px;
    vertical-align: top;
}

.form-check {
    display: flex;
    justify-content: center;
    align-items: center;
}
</style>
{% endblock %}
